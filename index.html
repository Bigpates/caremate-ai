<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Care Mate - Your NDIS Assistant</title>
    <style>
        :root {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2a2a2a;
            --accent-color: #4CAF50;
            --text-color: #f0f0f0;
            --input-bg: #333;
            --border-color: #444;
            --hover-color: #3a3a3a;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --error-color: #f44336;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --info-color: #2196F3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .shape {
            position: absolute;
            opacity: 0.05;
            filter: blur(40px);
            animation: float 15s infinite ease-in-out;
        }

        .shape:nth-child(1) {
            width: 300px;
            height: 300px;
            background: var(--accent-color);
            border-radius: 50%;
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }

        .shape:nth-child(2) {
            width: 200px;
            height: 200px;
            background: var(--info-color);
            border-radius: 30%;
            top: 60%;
            left: 70%;
            animation-delay: 2s;
        }

        .shape:nth-child(3) {
            width: 250px;
            height: 250px;
            background: var(--warning-color);
            border-radius: 40%;
            top: 10%;
            left: 80%;
            animation-delay: 4s;
        }

        @keyframes float {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }
            50% {
                transform: translate(100px, 50px) rotate(180deg);
            }
            100% {
                transform: translate(0, 0) rotate(360deg);
            }
        }

        /* App Layout */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background-color: var(--secondary-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .new-chat-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }

        .new-chat-btn:hover {
            background-color: #3d8b40;
        }

        .folder-section {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .folder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .folder-title {
            font-weight: 600;
            font-size: 14px;
            color: #aaa;
        }

        .add-folder-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 18px;
        }

        .folder-list {
            list-style: none;
        }

        .folder-item {
            display: flex;
            align-items: center;
            padding: 8px 5px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .folder-item:hover {
            background-color: var(--hover-color);
        }

        .folder-item.active {
            background-color: var(--hover-color);
            font-weight: 600;
        }

        .folder-icon {
            margin-right: 10px;
            font-size: 16px;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px 20px;
        }

        .chat-list-header {
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 14px;
            color: #aaa;
        }

        .chat-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: background-color 0.2s;
            position: relative;
        }

        .chat-item:hover {
            background-color: var(--hover-color);
        }

        .chat-item.active {
            background-color: var(--hover-color);
            font-weight: 600;
        }

        .chat-icon {
            margin-right: 10px;
            font-size: 16px;
            color: #aaa;
        }

        .chat-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        .chat-actions {
            display: none;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .chat-item:hover .chat-actions {
            display: flex;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
        }

        .chat-action-btn:hover {
            color: var(--text-color);
        }

        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-name {
            font-size: 14px;
        }

        /* Mobile sidebar toggle */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 100;
            background-color: var(--secondary-bg);
            border: none;
            color: var(--text-color);
            width: 40px;
            height: 40px;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .tagline {
            font-size: 16px;
            color: #aaa;
        }

        /* Onboarding */
        .onboarding-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .onboarding-card {
            background-color: var(--secondary-bg);
            border-radius: 10px;
            padding: 30px;
            width: 100%;
            box-shadow: 0 5px 15px var(--shadow-color);
        }

        .steps-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }

        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--border-color);
            margin: 0 5px;
        }

        .step-dot.active {
            background-color: var(--accent-color);
        }

        .onboarding-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .onboarding-subtitle {
            font-size: 16px;
            color: #aaa;
            margin-bottom: 30px;
            text-align: center;
        }

        .role-cards {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 20px;
        }

        .role-card {
            flex: 1;
            background-color: var(--input-bg);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .role-card:hover {
            background-color: var(--hover-color);
        }

        .role-card.selected {
            border-color: var(--accent-color);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .role-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .role-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .role-price {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .checkbox-group {
            margin-bottom: 20px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .checkbox-input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: var(--accent-color);
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: var(--hover-color);
        }

        .btn-primary {
            background-color: var(--accent-color);
            border: none;
            color: white;
        }

        .btn-primary:hover {
            background-color: #3d8b40;
        }

        /* Chat Interface */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 80%;
            margin-bottom: 20px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-assistant {
            align-self: flex-start;
        }

        .message-user {
            align-self: flex-end;
        }

        .message-content {
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px var(--shadow-color);
            white-space: pre-line;
        }

        .message-assistant .message-content {
            background-color: var(--secondary-bg);
            border-top-left-radius: 0;
        }

        .message-user .message-content {
            background-color: var(--accent-color);
            color: white;
            border-top-right-radius: 0;
        }

        .message-time {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
            text-align: right;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            align-self: flex-start;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #aaa;
            border-radius: 50%;
            margin: 0 2px;
            animation: typingAnimation 1.5s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .warning-message {
            background-color: rgba(255, 152, 0, 0.1);
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .warning-title {
            color: var(--warning-color);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .suggestion-btn {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .suggestion-btn:hover {
            background-color: var(--hover-color);
            border-color: var(--accent-color);
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--primary-bg);
        }

        .chat-input-wrapper {
            display: flex;
            align-items: flex-end;
            background-color: var(--secondary-bg);
            border-radius: 10px;
            padding: 10px 15px;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .chat-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 16px;
            min-height: 40px;
            max-height: 150px;
            resize: none;
            padding: 10px 0;
            outline: none;
        }

        .chat-input-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-input-btn {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .chat-input-btn:hover {
            color: var(--text-color);
            background-color: var(--hover-color);
        }

        .send-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .send-btn:hover {
            background-color: #3d8b40;
        }

        .send-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        /* File Upload */
        .file-upload-container {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--hover-color);
            border-radius: 5px;
            display: none;
        }

        .file-upload-container.active {
            display: block;
        }

        .file-upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .file-upload-title {
            font-weight: 600;
            font-size: 14px;
        }

        .file-upload-close {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 16px;
        }

        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            border-color: var(--accent-color);
            background-color: rgba(76, 175, 80, 0.05);
        }

        .file-upload-icon {
            font-size: 30px;
            color: #aaa;
            margin-bottom: 10px;
        }

        .file-upload-text {
            font-size: 14px;
            color: #aaa;
        }

        .file-upload-input {
            display: none;
        }

        .uploaded-files {
            margin-top: 15px;
        }

        .uploaded-file {
            display: flex;
            align-items: center;
            background-color: var(--input-bg);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .file-icon {
            margin-right: 10px;
            font-size: 20px;
            color: #aaa;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 14px;
            margin-bottom: 3px;
        }

        .file-size {
            font-size: 12px;
            color: #aaa;
        }

        .file-remove {
            background: none;
            border: none;
            color: var(--error-color);
            cursor: pointer;
            font-size: 16px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--secondary-bg);
            border-radius: 10px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-20px);
            transition: all 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #aaa;
            cursor: pointer;
            font-size: 24px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Debug Panel */
        .debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: #eee;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .debug-panel.active {
            display: block;
        }

        .debug-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            z-index: 1001;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: block;
            }

            .main-content {
                margin-left: 0;
            }

            .role-cards {
                flex-direction: column;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar Toggle (Mobile) -->
        <button class="sidebar-toggle" id="sidebarToggle">
            ☰
        </button>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="newChatBtn">
                    <span>+</span> New Chat
                </button>
            </div>

            <div class="folder-section">
                <div class="folder-header">
                    <div class="folder-title">FOLDERS</div>
                    <button class="add-folder-btn" id="addFolderBtn">+</button>
                </div>
                <ul class="folder-list" id="folderList">
                    <li class="folder-item active">
                        <span class="folder-icon">📁</span> All Chats
                    </li>
                    <li class="folder-item">
                        <span class="folder-icon">📁</span> NDIS Plans
                    </li>
                    <li class="folder-item">
                        <span class="folder-icon">📁</span> Service Providers
                    </li>
                </ul>
            </div>

            <div class="chat-list">
                <div class="chat-list-header">RECENT CHATS</div>
                <div id="chatList">
                    <!-- Chat items will be added here dynamically -->
                </div>
            </div>

            <div class="sidebar-footer">
                <button class="theme-toggle" id="themeToggle">
                    <span>🌙</span> Dark Mode
                </button>
                <div class="user-profile" id="userProfile">
                    <div class="user-avatar">J</div>
                    <div class="user-name">John</div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="logo">Care Mate</div>
                <div class="tagline">Your NDIS Assistant</div>
            </div>

            <!-- Onboarding Container (initially visible) -->
            <div class="onboarding-container" id="onboardingContainer">
                <div class="onboarding-card">
                    <div class="steps-indicator">
                        <div class="step-dot active" data-step="1"></div>
                        <div class="step-dot" data-step="2"></div>
                        <div class="step-dot" data-step="3"></div>
                    </div>

                    <!-- Step 1: Role Selection -->
                    <div class="onboarding-step" id="step1">
                        <h2 class="onboarding-title">Tell us about yourself</h2>
                        <p class="onboarding-subtitle">Select your role to help us personalize your experience</p>

                        <div class="role-cards">
                            <div class="role-card" data-role="participant">
                                <div class="role-icon">👤</div>
                                <div class="role-name">NDIS Participant</div>
                                <div class="role-price">$50/month</div>
                                <div>Access personalized NDIS guidance and support</div>
                            </div>
                            <div class="role-card" data-role="coordinator">
                                <div class="role-icon">👥</div>
                                <div class="role-name">Support Coordinator</div>
                                <div class="role-price">$100/month</div>
                                <div>Tools to manage multiple participants efficiently</div>
                            </div>
                            <div class="role-card" data-role="planmanager">
                                <div class="role-icon">💼</div>
                                <div class="role-name">Plan Manager</div>
                                <div class="role-price">$80/month</div>
                                <div>Financial management and reporting tools</div>
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-secondary" id="skipBtn">Skip</button>
                            <button class="btn btn-primary" id="nextBtn1">Continue</button>
                        </div>
                    </div>

                    <!-- Step 2: Personal Information -->
                    <div class="onboarding-step" id="step2" style="display: none;">
                        <h2 class="onboarding-title">Personal Information</h2>
                        <p class="onboarding-subtitle">This helps us provide personalized assistance</p>

                        <!-- Participant Form Fields -->
                        <div id="participantFields">
                            <div class="form-group">
                                <label class="form-label">Your Name</label>
                                <input type="text" class="form-input" id="participantName" placeholder="Enter your name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">NDIS Number</label>
                                <input type="text" class="form-input" id="ndisNumber" placeholder="Enter your NDIS number">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Plan Start Date</label>
                                    <input type="date" class="form-input" id="planStartDate">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Plan End Date</label>
                                    <input type="date" class="form-input" id="planEndDate">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Diagnosis (if known)</label>
                                <input type="text" class="form-input" id="diagnosis" placeholder="Optional">
                            </div>
                        </div>

                        <!-- Coordinator Form Fields -->
                        <div id="coordinatorFields" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Your Name</label>
                                <input type="text" class="form-input" id="coordinatorName" placeholder="Enter your name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Company Name</label>
                                <input type="text" class="form-input" id="coordinatorCompany" placeholder="Enter your company name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Registration Number</label>
                                <input type="text" class="form-input" id="coordinatorRegistration" placeholder="Enter your registration number">
                            </div>
                        </div>

                        <!-- Plan Manager Form Fields -->
                        <div id="planManagerFields" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Your Name</label>
                                <input type="text" class="form-input" id="managerName" placeholder="Enter your name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Company Name</label>
                                <input type="text" class="form-input" id="managerCompany" placeholder="Enter your company name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Registration Number</label>
                                <input type="text" class="form-input" id="managerRegistration" placeholder="Enter your registration number">
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-secondary" id="backBtn2">Back</button>
                            <button class="btn btn-primary" id="nextBtn2">Continue</button>
                        </div>
                    </div>

                    <!-- Step 3: Preferences -->
                    <div class="onboarding-step" id="step3" style="display: none;">
                        <h2 class="onboarding-title">Your Preferences</h2>
                        <p class="onboarding-subtitle">Help us understand your needs better</p>

                        <div class="form-group">
                            <label class="form-label">Current Level of Support</label>
                            <select class="form-input" id="supportLevel">
                                <option value="">Select your level of support</option>
                                <option value="low">Low - Minimal assistance needed</option>
                                <option value="medium">Medium - Regular assistance needed</option>
                                <option value="high">High - Significant assistance needed</option>
                                <option value="very-high">Very High - Constant assistance needed</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Primary Purpose</label>
                            <select class="form-input" id="primaryPurpose">
                                <option value="">What brings you to Care Mate?</option>
                                <option value="plan-management">Help with plan management</option>
                                <option value="find-providers">Finding service providers</option>
                                <option value="understand-ndis">Understanding NDIS better</option>
                                <option value="document-creation">Creating NDIS documents</option>
                                <option value="funding-advice">Advice on using funding</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="checkbox-group">
                            <label class="form-label">Areas you need assistance with:</label>
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox-input" value="funding"> Understanding funding categories
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox-input" value="providers"> Finding and managing service providers
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox-input" value="documents"> Creating and managing documents
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox-input" value="goals"> Setting and tracking goals
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox-input" value="reviews"> Preparing for plan reviews
                            </label>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Additional Information</label>
                            <textarea class="form-input" id="additionalInfo" rows="3" placeholder="Anything else you'd like us to know?"></textarea>
                        </div>

                        <div class="button-group">
                            <button class="btn btn-secondary" id="backBtn3">Back</button>
                            <button class="btn btn-primary" id="finishBtn">Get Started</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Container (initially hidden) -->
            <div class="chat-container" id="chatContainer" style="display: none;">
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be added here dynamically -->
                </div>

                <div class="chat-input-container">
                    <div class="suggestions" id="suggestions">
                        <button class="suggestion-btn">Help me manage my NDIS plan</button>
                        <button class="suggestion-btn">Explain my funding categories</button>
                        <button class="suggestion-btn">Find service providers near me</button>
                        <button class="suggestion-btn">Create an NDIS-compliant document</button>
                    </div>

                    <div class="chat-input-wrapper">
                        <textarea class="chat-input" id="messageInput" placeholder="Type your message here..." rows="1"></textarea>
                        <div class="chat-input-actions">
                            <button class="chat-input-btn" id="uploadBtn" title="Upload File">
                                📎
                            </button>
                            <button class="send-btn" id="sendBtn" disabled>
                                ➤
                            </button>
                        </div>
                    </div>

                    <div class="file-upload-container" id="fileUploadContainer">
                        <div class="file-upload-header">
                            <div class="file-upload-title">Upload Files</div>
                            <button class="file-upload-close" id="closeUploadBtn">×</button>
                        </div>
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="file-upload-icon">📄</div>
                            <div class="file-upload-text">Drag and drop files here or click to browse</div>
                            <input type="file" class="file-upload-input" id="fileUploadInput" multiple>
                        </div>
                        <div class="uploaded-files" id="uploadedFiles">
                            <!-- Uploaded files will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Rename Chat Modal -->
    <div class="modal-overlay" id="renameChatModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Rename Chat</div>
                <button class="modal-close" id="closeRenameModal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Chat Name</label>
                    <input type="text" class="form-input" id="chatNameInput" placeholder="Enter a name for this chat">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelRenameBtn">Cancel</button>
                <button class="btn btn-primary" id="saveRenameBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- New Folder Modal -->
    <div class="modal-overlay" id="newFolderModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Create New Folder</div>
                <button class="modal-close" id="closeNewFolderModal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Folder Name</label>
                    <input type="text" class="form-input" id="folderNameInput" placeholder="Enter a name for this folder">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelNewFolderBtn">Cancel</button>
                <button class="btn btn-primary" id="saveNewFolderBtn">Create</button>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel"></div>
    <button class="debug-toggle" id="debugToggle">Show Debug Info</button>

    <script>
        // Global variables
        let selectedRole = '';
        let userProfile = {};
        let currentChatId = null;
        let chats = {};
        let folders = [
            { id: 'all', name: 'All Chats', isDefault: true },
            { id: 'ndis-plans', name: 'NDIS Plans' },
            { id: 'service-providers', name: 'Service Providers' }
        ];
        let sessionId = generateSessionId();
        let isTyping = false;
        let uploadedFiles = [];
        let isDarkMode = true;

        // API URL - direct connection to Replit backend
        const API_URL = 'https://caremate-ai-backend-ts67450.replit.app/chat';

        // DOM Elements
        const onboardingContainer = document.getElementById('onboardingContainer');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const suggestions = document.getElementById('suggestions');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const chatList = document.getElementById('chatList');
        const newChatBtn = document.getElementById('newChatBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileUploadContainer = document.getElementById('fileUploadContainer');
        const closeUploadBtn = document.getElementById('closeUploadBtn');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileUploadInput = document.getElementById('fileUploadInput');
        const uploadedFilesContainer = document.getElementById('uploadedFiles');
        const debugPanel = document.getElementById('debugPanel');
        const debugToggle = document.getElementById('debugToggle');
        const themeToggle = document.getElementById('themeToggle');
        const renameChatModal = document.getElementById('renameChatModal');
        const chatNameInput = document.getElementById('chatNameInput');
        const saveRenameBtn = document.getElementById('saveRenameBtn');
        const cancelRenameBtn = document.getElementById('cancelRenameBtn');
        const closeRenameModal = document.getElementById('closeRenameModal');
        const newFolderModal = document.getElementById('newFolderModal');
        const folderNameInput = document.getElementById('folderNameInput');
        const saveNewFolderBtn = document.getElementById('saveNewFolderBtn');
        const cancelNewFolderBtn = document.getElementById('cancelNewFolderBtn');
        const closeNewFolderModal = document.getElementById('closeNewFolderModal');
        const addFolderBtn = document.getElementById('addFolderBtn');
        const folderList = document.getElementById('folderList');

        // Onboarding elements
        const roleCards = document.querySelectorAll('.role-card');
        const nextBtn1 = document.getElementById('nextBtn1');
        const nextBtn2 = document.getElementById('nextBtn2');
        const backBtn2 = document.getElementById('backBtn2');
        const backBtn3 = document.getElementById('backBtn3');
        const finishBtn = document.getElementById('finishBtn');
        const skipBtn = document.getElementById('skipBtn');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const participantFields = document.getElementById('participantFields');
        const coordinatorFields = document.getElementById('coordinatorFields');
        const planManagerFields = document.getElementById('planManagerFields');

        // Initialize the application
        function init() {
            // Check if user has completed onboarding
            const savedProfile = localStorage.getItem('userProfile');
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
                selectedRole = userProfile.role;
                completeOnboarding();
            }

            // Load saved chats
            loadChats();

            // Event listeners
            setupEventListeners();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Onboarding event listeners
            roleCards.forEach(card => {
                card.addEventListener('click', () => {
                    roleCards.forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedRole = card.dataset.role;
                });
            });

            nextBtn1.addEventListener('click', () => {
                if (!selectedRole) {
                    alert('Please select a role to continue');
                    return;
                }
                step1.style.display = 'none';
                step2.style.display = 'block';
                document.querySelector('.step-dot[data-step="1"]').classList.remove('active');
                document.querySelector('.step-dot[data-step="2"]').classList.add('active');

                // Show appropriate fields based on role
                participantFields.style.display = 'none';
                coordinatorFields.style.display = 'none';
                planManagerFields.style.display = 'none';

                if (selectedRole === 'participant') {
                    participantFields.style.display = 'block';
                } else if (selectedRole === 'coordinator') {
                    coordinatorFields.style.display = 'block';
                } else if (selectedRole === 'planmanager') {
                    planManagerFields.style.display = 'block';
                }
            });

            nextBtn2.addEventListener('click', () => {
                // Validate fields based on role
                let isValid = true;
                if (selectedRole === 'participant') {
                    if (!document.getElementById('participantName').value) {
                        alert('Please enter your name');
                        isValid = false;
                    }
                } else if (selectedRole === 'coordinator') {
                    if (!document.getElementById('coordinatorName').value) {
                        alert('Please enter your name');
                        isValid = false;
                    }
                } else if (selectedRole === 'planmanager') {
                    if (!document.getElementById('managerName').value) {
                        alert('Please enter your name');
                        isValid = false;
                    }
                }

                if (!isValid) return;

                step2.style.display = 'none';
                step3.style.display = 'block';
                document.querySelector('.step-dot[data-step="2"]').classList.remove('active');
                document.querySelector('.step-dot[data-step="3"]').classList.add('active');
            });

            backBtn2.addEventListener('click', () => {
                step2.style.display = 'none';
                step1.style.display = 'block';
                document.querySelector('.step-dot[data-step="2"]').classList.remove('active');
                document.querySelector('.step-dot[data-step="1"]').classList.add('active');
            });

            backBtn3.addEventListener('click', () => {
                step3.style.display = 'none';
                step2.style.display = 'block';
                document.querySelector('.step-dot[data-step="3"]').classList.remove('active');
                document.querySelector('.step-dot[data-step="2"]').classList.add('active');
            });

            finishBtn.addEventListener('click', () => {
                saveUserProfile();
                completeOnboarding();
            });

            skipBtn.addEventListener('click', () => {
                completeOnboarding();
            });

            // Chat interface event listeners
            messageInput.addEventListener('input', () => {
                // Auto-resize textarea
                messageInput.style.height = 'auto';
                messageInput.style.height = messageInput.scrollHeight + 'px';
                
                // Enable/disable send button
                sendBtn.disabled = messageInput.value.trim() === '';
            });

            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!sendBtn.disabled) {
                        sendMessage();
                    }
                }
            });

            sendBtn.addEventListener('click', sendMessage);

            // Suggestion buttons
            suggestions.addEventListener('click', (e) => {
                if (e.target.classList.contains('suggestion-btn')) {
                    messageInput.value = e.target.textContent;
                    messageInput.dispatchEvent(new Event('input'));
                    sendMessage();
                }
            });

            // Sidebar toggle (mobile)
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            // New chat button
            newChatBtn.addEventListener('click', () => {
                startNewChat();
            });

            // File upload
            uploadBtn.addEventListener('click', () => {
                fileUploadContainer.classList.toggle('active');
            });

            closeUploadBtn.addEventListener('click', () => {
                fileUploadContainer.classList.remove('active');
            });

            fileUploadArea.addEventListener('click', () => {
                fileUploadInput.click();
            });

            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.style.borderColor = 'var(--accent-color)';
                fileUploadArea.style.backgroundColor = 'rgba(76, 175, 80, 0.05)';
            });

            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.style.borderColor = 'var(--border-color)';
                fileUploadArea.style.backgroundColor = 'transparent';
            });

            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.style.borderColor = 'var(--border-color)';
                fileUploadArea.style.backgroundColor = 'transparent';
                
                const files = e.dataTransfer.files;
                handleFileUpload(files);
            });

            fileUploadInput.addEventListener('change', () => {
                handleFileUpload(fileUploadInput.files);
            });

            // Debug panel
            debugToggle.addEventListener('click', () => {
                debugPanel.classList.toggle('active');
                debugToggle.textContent = debugPanel.classList.contains('active') ? 'Hide Debug Info' : 'Show Debug Info';
            });

            // Theme toggle
            themeToggle.addEventListener('click', () => {
                toggleTheme();
            });

            // Rename chat modal
            saveRenameBtn.addEventListener('click', () => {
                const newName = chatNameInput.value.trim();
                if (newName && currentChatId) {
                    renameChat(currentChatId, newName);
                    renameChatModal.classList.remove('active');
                }
            });

            cancelRenameBtn.addEventListener('click', () => {
                renameChatModal.classList.remove('active');
            });

            closeRenameModal.addEventListener('click', () => {
                renameChatModal.classList.remove('active');
            });

            // New folder modal
            addFolderBtn.addEventListener('click', () => {
                newFolderModal.classList.add('active');
            });

            saveNewFolderBtn.addEventListener('click', () => {
                const folderName = folderNameInput.value.trim();
                if (folderName) {
                    createNewFolder(folderName);
                    newFolderModal.classList.remove('active');
                    folderNameInput.value = '';
                }
            });

            cancelNewFolderBtn.addEventListener('click', () => {
                newFolderModal.classList.remove('active');
            });

            closeNewFolderModal.addEventListener('click', () => {
                newFolderModal.classList.remove('active');
            });
        }

        // Save user profile from onboarding
        function saveUserProfile() {
            userProfile = {
                role: selectedRole
            };

            if (selectedRole === 'participant') {
                userProfile.name = document.getElementById('participantName').value;
                userProfile.ndisNumber = document.getElementById('ndisNumber').value;
                userProfile.planStartDate = document.getElementById('planStartDate').value;
                userProfile.planEndDate = document.getElementById('planEndDate').value;
                userProfile.diagnosis = document.getElementById('diagnosis').value;
            } else if (selectedRole === 'coordinator') {
                userProfile.name = document.getElementById('coordinatorName').value;
                userProfile.company = document.getElementById('coordinatorCompany').value;
                userProfile.registrationNumber = document.getElementById('coordinatorRegistration').value;
            } else if (selectedRole === 'planmanager') {
                userProfile.name = document.getElementById('managerName').value;
                userProfile.company = document.getElementById('managerCompany').value;
                userProfile.registrationNumber = document.getElementById('managerRegistration').value;
            }

            userProfile.supportLevel = document.getElementById('supportLevel').value;
            userProfile.purpose = document.getElementById('primaryPurpose').value;
            
            // Get selected assistance areas
            const assistanceAreas = [];
            document.querySelectorAll('.checkbox-input:checked').forEach(checkbox => {
                assistanceAreas.push(checkbox.value);
            });
            userProfile.assistanceAreas = assistanceAreas;
            
            userProfile.additionalInfo = document.getElementById('additionalInfo').value;

            // Save to localStorage
            localStorage.setItem('userProfile', JSON.stringify(userProfile));

            // Update user profile display
            if (userProfile.name) {
                document.querySelector('.user-name').textContent = userProfile.name;
                document.querySelector('.user-avatar').textContent = userProfile.name.charAt(0);
            }
        }

        // Complete onboarding and show chat interface
        function completeOnboarding() {
            onboardingContainer.style.display = 'none';
            chatContainer.style.display = 'flex';
            
            // Start a new chat if none exists
            if (Object.keys(chats).length === 0) {
                startNewChat();
            } else {
                // Load the most recent chat
                const chatIds = Object.keys(chats);
                if (chatIds.length > 0) {
                    loadChat(chatIds[chatIds.length - 1]);
                }
            }
        }

        // Start a new chat
        function startNewChat() {
            // Generate a new chat ID
            const chatId = generateChatId();
            
            // Create a new chat object
            chats[chatId] = {
                id: chatId,
                title: 'New Chat',
                messages: [],
                createdAt: new Date().toISOString(),
                folderId: 'all'
            };
            
            // Save chats to localStorage
            saveChats();
            
            // Add chat to the list
            addChatToList(chats[chatId]);
            
            // Load the new chat
            loadChat(chatId);
            
            // Add welcome message
            addAssistantMessage('Hello! I\'m Care Mate, your NDIS assistant. How can I help you today?');
            
            // Show suggestions
            suggestions.style.display = 'flex';
        }

        // Load a specific chat
        function loadChat(chatId) {
            if (!chats[chatId]) return;
            
            // Set current chat ID
            currentChatId = chatId;
            
            // Clear chat messages
            chatMessages.innerHTML = '';
            
            // Load messages
            chats[chatId].messages.forEach(msg => {
                if (msg.role === 'user') {
                    addUserMessage(msg.content, msg.timestamp);
                } else {
                    addAssistantMessage(msg.content, msg.timestamp);
                }
            });
            
            // Update active chat in the list
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            const chatItem = document.querySelector(`.chat-item[data-id="${chatId}"]`);
            if (chatItem) {
                chatItem.classList.add('active');
            }
            
            // Hide suggestions if chat has messages
            if (chats[chatId].messages.length > 0) {
                suggestions.style.display = 'none';
            } else {
                suggestions.style.display = 'flex';
            }
            
            // Scroll to bottom
            scrollToBottom();
        }

        // Add a chat to the sidebar list
        function addChatToList(chat) {
            // Create chat item element
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            chatItem.dataset.id = chat.id;
            
            // Create chat content
            chatItem.innerHTML = `
                <span class="chat-icon">💬</span>
                <div class="chat-title">${chat.title}</div>
                <div class="chat-actions">
                    <button class="chat-action-btn rename-btn" title="Rename">✏️</button>
                    <button class="chat-action-btn delete-btn" title="Delete">🗑️</button>
                </div>
            `;
            
            // Add event listeners
            chatItem.addEventListener('click', () => {
                loadChat(chat.id);
            });
            
            chatItem.querySelector('.rename-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                openRenameModal(chat.id);
            });
            
            chatItem.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteChat(chat.id);
            });
            
            // Add to chat list
            chatList.prepend(chatItem);
        }

        // Send a message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Add user message to UI
            addUserMessage(message);
            
            // Save message to chat history
            saveMessage('user', message);
            
            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';
            sendBtn.disabled = true;
            
            // Hide suggestions
            suggestions.style.display = 'none';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Send to API
            sendToAPI(message);
        }

        // Add a user message to the chat
        function addUserMessage(message, timestamp = new Date().toISOString()) {
            const messageElement = document.createElement('div');
            messageElement.className = 'message message-user';
            
            const formattedTime = formatTimestamp(timestamp);
            
            messageElement.innerHTML = `
                <div class="message-content">${message}</div>
                <div class="message-time">${formattedTime}</div>
            `;
            
            chatMessages.appendChild(messageElement);
            scrollToBottom();
        }

        // Add an assistant message to the chat
        function addAssistantMessage(message, timestamp = new Date().toISOString()) {
            // Remove typing indicator if present
            removeTypingIndicator();
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message message-assistant';
            
            const formattedTime = formatTimestamp(timestamp);
            
            // Format warnings in the message
            let formattedMessage = message;
            
            // Check for warning format
            if (message.includes('⚠️ Warning')) {
                // Split by warning markers
                const parts = message.split('⚠️ Warning');
                
                formattedMessage = parts[0]; // Text before first warning
                
                // Process each warning
                for (let i = 1; i < parts.length; i++) {
                    const warningContent = parts[i];
                    formattedMessage += `
                        <div class="warning-message">
                            <div class="warning-title">⚠️ Warning${warningContent.split('\n')[0]}</div>
                            ${warningContent.split('\n').slice(1).join('\n')}
                        </div>
                    `;
                    
                    // Add any text after the warning
                    if (i < parts.length - 1) {
                        formattedMessage += parts[i].split('\n\n').slice(-1)[0];
                    }
                }
            }
            
            messageElement.innerHTML = `
                <div class="message-content">${formattedMessage}</div>
                <div class="message-time">${formattedTime}</div>
            `;
            
            chatMessages.appendChild(messageElement);
            scrollToBottom();
        }

        // Show typing indicator
        function showTypingIndicator() {
            if (isTyping) return;
            
            isTyping = true;
            const typingElement = document.createElement('div');
            typingElement.className = 'typing-indicator';
            typingElement.id = 'typingIndicator';
            
            typingElement.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            
            chatMessages.appendChild(typingElement);
            scrollToBottom();
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            isTyping = false;
            const typingElement = document.getElementById('typingIndicator');
            if (typingElement) {
                typingElement.remove();
            }
        }

        // Send message to API
        async function sendToAPI(message) {
            try {
                addDebugEntry(`Sending message: "${message}"`);
                addDebugEntry(`Fetching ${API_URL} with message: "${message}"`);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        sessionId: sessionId,
                        userRole: userProfile.role,
                        userProfile: userProfile
                    })
                });
                
                addDebugEntry(`Response status: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`Response not OK (${response.status})`);
                }
                
                const data = await response.json();
                addDebugEntry(`Received response from OpenAI API`);
                
                // Add assistant message to UI
                addAssistantMessage(data.reply);
                
                // Save message to chat history
                saveMessage('assistant', data.reply);
                
            } catch (err) {
                addDebugEntry(`Error: ${err.message}`);
                removeTypingIndicator();
                addAssistantMessage("Sorry, I encountered an error. Please try again later.");
            }
        }

        // Save message to chat history
        function saveMessage(role, content) {
            if (!currentChatId || !chats[currentChatId]) return;
            
            // Add message to chat
            chats[currentChatId].messages.push({
                role: role,
                content: content,
                timestamp: new Date().toISOString()
            });
            
            // Update chat title if it's the first user message
            if (role === 'user' && chats[currentChatId].messages.filter(m => m.role === 'user').length === 1) {
                // Use first 30 characters of message as title
                const title = content.length > 30 ? content.substring(0, 30) + '...' : content;
                chats[currentChatId].title = title;
                
                // Update title in sidebar
                const chatItem = document.querySelector(`.chat-item[data-id="${currentChatId}"]`);
                if (chatItem) {
                    chatItem.querySelector('.chat-title').textContent = title;
                }
            }
            
            // Save chats to localStorage
            saveChats();
        }

        // Rename a chat
        function renameChat(chatId, newName) {
            if (!chats[chatId]) return;
            
            chats[chatId].title = newName;
            
            // Update title in sidebar
            const chatItem = document.querySelector(`.chat-item[data-id="${chatId}"]`);
            if (chatItem) {
                chatItem.querySelector('.chat-title').textContent = newName;
            }
            
            // Save chats to localStorage
            saveChats();
        }

        // Delete a chat
        function deleteChat(chatId) {
            if (!chats[chatId]) return;
            
            // Confirm deletion
            if (!confirm('Are you sure you want to delete this chat?')) return;
            
            // Remove chat from list
            const chatItem = document.querySelector(`.chat-item[data-id="${chatId}"]`);
            if (chatItem) {
                chatItem.remove();
            }
            
            // Delete chat object
            delete chats[chatId];
            
            // Save chats to localStorage
            saveChats();
            
            // If current chat was deleted, load another chat or start a new one
            if (currentChatId === chatId) {
                const chatIds = Object.keys(chats);
                if (chatIds.length > 0) {
                    loadChat(chatIds[0]);
                } else {
                    startNewChat();
                }
            }
        }

        // Create a new folder
        function createNewFolder(folderName) {
            const folderId = 'folder-' + Date.now();
            
            // Add to folders array
            folders.push({
                id: folderId,
                name: folderName,
                isDefault: false
            });
            
            // Add to folder list
            const folderItem = document.createElement('li');
            folderItem.className = 'folder-item';
            folderItem.dataset.id = folderId;
            folderItem.innerHTML = `
                <span class="folder-icon">📁</span> ${folderName}
            `;
            
            folderItem.addEventListener('click', () => {
                // Highlight selected folder
                document.querySelectorAll('.folder-item').forEach(item => {
                    item.classList.remove('active');
                });
                folderItem.classList.add('active');
                
                // Filter chats by folder
                filterChatsByFolder(folderId);
            });
            
            folderList.appendChild(folderItem);
        }

        // Filter chats by folder
        function filterChatsByFolder(folderId) {
            // Show all chats if "All Chats" folder is selected
            if (folderId === 'all') {
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.style.display = 'flex';
                });
                return;
            }
            
            // Filter chats by folder ID
            document.querySelectorAll('.chat-item').forEach(item => {
                const chatId = item.dataset.id;
                if (chats[chatId] && chats[chatId].folderId === folderId) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Open rename chat modal
        function openRenameModal(chatId) {
            currentChatId = chatId;
            chatNameInput.value = chats[chatId].title;
            renameChatModal.classList.add('active');
            chatNameInput.focus();
        }

        // Handle file upload
        function handleFileUpload(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // Check file type
                const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Only PDF and DOC files are supported');
                    continue;
                }
                
                // Check file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB');
                    continue;
                }
                
                // Add file to uploaded files
                uploadedFiles.push(file);
                
                // Add file to UI
                const fileElement = document.createElement('div');
                fileElement.className = 'uploaded-file';
                
                const fileIcon = file.type.includes('pdf') ? '📄' : '📝';
                const fileSize = formatFileSize(file.size);
                
                fileElement.innerHTML = `
                    <div class="file-icon">${fileIcon}</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                    </div>
                    <button class="file-remove" data-index="${uploadedFiles.length - 1}">×</button>
                `;
                
                fileElement.querySelector('.file-remove').addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    uploadedFiles.splice(index, 1);
                    fileElement.remove();
                    
                    // Update indexes for remaining files
                    document.querySelectorAll('.file-remove').forEach((btn, i) => {
                        btn.dataset.index = i;
                    });
                });
                
                uploadedFilesContainer.appendChild(fileElement);
            }
            
            // Reset file input
            fileUploadInput.value = '';
        }

        // Toggle theme
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            
            if (isDarkMode) {
                document.documentElement.style.setProperty('--primary-bg', '#1a1a1a');
                document.documentElement.style.setProperty('--secondary-bg', '#2a2a2a');
                document.documentElement.style.setProperty('--text-color', '#f0f0f0');
                document.documentElement.style.setProperty('--input-bg', '#333');
                document.documentElement.style.setProperty('--border-color', '#444');
                document.documentElement.style.setProperty('--hover-color', '#3a3a3a');
                themeToggle.innerHTML = '<span>🌙</span> Dark Mode';
            } else {
                document.documentElement.style.setProperty('--primary-bg', '#f5f5f5');
                document.documentElement.style.setProperty('--secondary-bg', '#ffffff');
                document.documentElement.style.setProperty('--text-color', '#333333');
                document.documentElement.style.setProperty('--input-bg', '#f0f0f0');
                document.documentElement.style.setProperty('--border-color', '#e0e0e0');
                document.documentElement.style.setProperty('--hover-color', '#f0f0f0');
                themeToggle.innerHTML = '<span>☀️</span> Light Mode';
            }
        }

        // Save chats to localStorage
        function saveChats() {
            localStorage.setItem('chats', JSON.stringify(chats));
        }

        // Load chats from localStorage
        function loadChats() {
            const savedChats = localStorage.getItem('chats');
            if (savedChats) {
                chats = JSON.parse(savedChats);
                
                // Add chats to the list
                Object.values(chats).forEach(chat => {
                    addChatToList(chat);
                });
            }
        }

        // Helper functions
        function generateSessionId() {
            return 'session-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
        }

        function generateChatId() {
            return 'chat-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addDebugEntry(message) {
            const entry = document.createElement('div');
            entry.className = 'debug-entry';
            
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            entry.textContent = `[${timestamp}] ${message}`;
            
            debugPanel.appendChild(entry);
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
